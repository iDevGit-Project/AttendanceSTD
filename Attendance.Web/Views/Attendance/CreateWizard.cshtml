@{
    ViewData["Title"] = "ایجاد جلسه حضور و غیاب - ویزارد";
    Layout = "_Layout"; // اگر layout متفاوت است آنرا تغییر دهید
}

@* فرم پنهان فقط برای تولید توکن antiforgery در DOM (JS آن را می‌خواند) *@
<form id="__antiforgery" style="display:none" method="post" asp-action="CreateSession" asp-controller="Attendance">
    @Html.AntiForgeryToken()
</form>

<div class="max-w-4xl mx-auto py-6">
    <div class="bg-white rounded-lg border p-6 space-y-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">ایجاد جلسه حضور و غیاب (Wizard)</h1>
                <p class="text-sm text-slate-500">مراحل را دنبال کنید تا جلسه جدید ثبت شود.</p>
            </div>
            <div>
                <a asp-action="Index" asp-controller="Attendance" class="inline-block px-3 py-2 bg-slate-100 rounded font-bold hover:bg-slate-200">بازگشت</a>
            </div>
        </div>

        <hr class="border-slate-200" />

        <!-- Wizard Step 1 -->
        <div id="step-1" class="space-y-4">
            <h2 class="text-lg font-semibold text-slate-700">مرحله ۱ — انتخاب پایه تحصیلی</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div class="col-span-2">
                    <label for="wizard-grade" class="block text-sm font-medium text-slate-700">پایه</label>
                    <select id="wizard-grade" class="mt-1 block w-full rounded border px-3 py-2 bg-amber-50">
                        <option value="">-- یک پایه انتخاب کنید --</option>
                        @* ViewBag.Grades باید توسط کنترلر پر شود *@
                        @if (ViewBag.Grades is Microsoft.AspNetCore.Mvc.Rendering.SelectList sl)
                        {
                            foreach (var item in sl)
                            {
                                <option value="@(item.Value?.ToString() ?? item.Text)">@item.Text</option>
                            }
                        }
                    </select>
                </div>

                <div class="flex items-center gap-2">
                    <button id="to-step-2" type="button" class="inline-block bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">
                        رفتن به مرحله بعد
                    </button>
                    <a asp-action="Index" asp-controller="Attendance" class="inline-block px-3 py-2 rounded border hover:bg-slate-50">انصراف</a>
                </div>
            </div>
        </div>

        <!-- Wizard Step 2 (hidden initially) -->
        <div id="step-2" class="space-y-4 hidden">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-700">مرحله ۲ — انتخاب دانش‌آموزان (پایه: <span id="selected-grade" class="font-bold"></span>)</h2>
                <div class="flex items-center gap-2">
                    <button id="back-to-step-1" type="button" class="inline-block px-3 py-2 rounded border hover:bg-slate-50">برگشت</button>
                </div>
            </div>

            <div id="students-list" class="grid grid-cols-1 gap-2">
                @* JS will populate student items here (each item contains a checkbox with class .student-checkbox) *@
                <div class="text-sm text-slate-500">دانش‌آموزان در اینجا نمایش داده خواهند شد.</div>
            </div>

            <div class="flex items-center justify-end gap-2 pt-4">
                <button id="to-step-3" type="button" class="inline-block bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700">
                    ایجاد جلسه با دانش‌آموزان انتخاب‌شده
                </button>
            </div>
        </div>

        <hr class="border-slate-200" />

        <div class="text-xs text-slate-500">توضیح: بعد از زدن "ایجاد جلسه"، نام جلسه از شما پرسیده می‌شود و سپس جلسه بصورت AJAX ثبت خواهد شد.</div>
    </div>
</div>

@section CreateWizardSesstionScripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        (function () {
            // عناصر DOM (اطمینان از وجودشان در صفحه)
            const gradeSelect = document.getElementById('wizard-grade');
            const toStep2Btn = document.getElementById('to-step-2');
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const backBtn = document.getElementById('back-to-step-1');
            const studentsList = document.getElementById('students-list');
            const selectedGradeSpan = document.getElementById('selected-grade');
            const toStep3Btn = document.getElementById('to-step-3');

            // helper: خواندن antiforgery token از DOM
            function getAntiForgeryToken() {
                const el = document.querySelector('input[name="__RequestVerificationToken"]');
                return el ? el.value : null;
            }

            // Step1 -> Step2 : بارگذاری فهرست دانش‌آموزان برای پایه انتخاب‌شده
            toStep2Btn.addEventListener('click', async function () {
                const g = gradeSelect?.value;
                if (!g) {
                    Swal.fire({ icon: 'warning', title: 'لطفاً یک پایه انتخاب کنید' });
                    return;
                }

                Swal.fire({ title: 'در حال بارگذاری دانش‌آموزان...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

                try {
                    // ساخت URL امن با جایگزینی (اجتناب از تداخل Razor)
                    const urlTemplate = '@Url.Action("GetStudentsByGrade", "Attendance")?grade=PLACEHOLDER';
                    const url = urlTemplate.replace('PLACEHOLDER', encodeURIComponent(g));

                    const res = await fetch(url, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        credentials: 'same-origin'
                    });

                    if (!res.ok) {
                        const txt = await res.text();
                        console.error('GetStudentsByGrade failed', res.status, txt);
                        throw new Error('بارگذاری دانش‌آموزان موفق نبود');
                    }

                    const data = await res.json();

                    studentsList.innerHTML = '';
                    data.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-3 p-2 border rounded';
                        // شامل checkbox (checked پیش‌فرض) و تصویر و نام
                        div.innerHTML = `
                            <label class="flex items-center gap-3 w-full cursor-pointer">
                                <input type="checkbox" class="student-checkbox" value="${s.id}" id="st-${s.id}" checked />
                                <img src="${s.photo || '/uploads/students/default.png'}" class="w-10 h-10 rounded object-cover" alt="photo-${s.id}" />
                                <div class="flex-1">
                                    <div class="font-bold">${s.firstName || ''} ${s.lastName || ''}</div>
                                    <div class="text-xs text-slate-500">${s.nationalCode ?? ''}</div>
                                </div>
                            </label>
                        `;
                        studentsList.appendChild(div);
                    });

                    selectedGradeSpan.textContent = g;
                    step1.classList.add('hidden');
                    step2.classList.remove('hidden');
                } catch (err) {
                    console.error(err);
                    Swal.fire({ icon: 'error', title: 'خطا', text: 'بارگذاری لیست دانش‌آموزان ناموفق بود.' });
                } finally {
                    Swal.close();
                }
            });

            // back
            backBtn.addEventListener('click', function () {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            });

            // Step2 -> Step3 (ایجاد جلسه): درخواست اطلاعات جلسه از مدیر با Swal (title, startTime, location)
            toStep3Btn.addEventListener('click', async function () {
                const grade = gradeSelect?.value;
                const checked = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(x => parseInt(x.value, 10));

                if (!grade) return Swal.fire({ icon: 'warning', text: 'پایه انتخاب نشده' });
                if (!checked.length) return Swal.fire({ icon: 'warning', text: 'هیچ دانش‌آموزی انتخاب نشده' });

                // تاریخ شمسی امروز (نمایشی) — توجه: سرور برای تبدیل حقیقی تاریخ از PersianDateConverter استفاده می‌کند
                const todayShamsi = (new Date()).toLocaleDateString('fa-IR-u-nu-latn');

                // فرم سفارشی Swal برای گرفتن نام، زمان شروع و مکان
                const { value: formValues } = await Swal.fire({
                    title: 'مشخصات جلسه',
                    html:
                        `<input id="swal-title" class="swal2-input" placeholder="نام جلسه">` +
                        `<div class="flex gap-2"><input id="swal-start" type="time" class="swal2-input" style="width:50%" placeholder="ساعت شروع (اختیاری)"><input id="swal-location" class="swal2-input" style="width:50%" placeholder="مکان (اختیاری)"></div>` +
                        `<div class="text-sm mt-1">تاریخ جلسه (شمسی): ${todayShamsi}</div>`,
                    focusConfirm: false,
                    showCancelButton: true,
                    preConfirm: () => {
                        const t = document.getElementById('swal-title')?.value?.trim();
                        const start = document.getElementById('swal-start')?.value;
                        const loc = document.getElementById('swal-location')?.value?.trim();
                        if (!t) {
                            Swal.showValidationMessage('نام جلسه لازم است');
                            return false;
                        }
                        return { title: t, startTime: start || null, location: loc || null, dateShamsi: todayShamsi };
                    }
                });

                if (!formValues) return; // کاربر انصراف زده

                const title = formValues.title;
                const dateShamsi = formValues.dateShamsi;
                const startTime = formValues.startTime; // format "HH:mm" or null
                const location = formValues.location;

                // ساخت FormData برای ارسال به سرور
                const fd = new FormData();
                fd.append('title', title);
                fd.append('dateShamsi', dateShamsi);
                fd.append('grade', grade);
                if (startTime) fd.append('startTime', startTime);
                if (location) fd.append('location', location);
                // append multiple values with same key for model binder to bind to int[] studentIds
                checked.forEach(id => fd.append('studentIds', id));

                // antiforgery token
                const anti = getAntiForgeryToken();
                if (anti) {
                    // بعضی از پروژه‌ها توکن را در header هم قبول می‌کنند؛ ما FormData هم مقدار می‌گذاریم
                    fd.append('__RequestVerificationToken', anti);
                } else {
                    console.warn('Anti-forgery token not found in DOM.');
                }

                Swal.fire({ title: 'در حال ایجاد جلسه...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                try {
                    const resp = await fetch('@Url.Action("CreateSessionAjax", "Attendance")', {
                        method: 'POST',
                        credentials: 'same-origin', // ارسال کوکی‌ها برای antiforgery/احراز هویت
                        body: fd
                    });

                    // خواندن متن پاسخ برای خطایابی
                    const text = await resp.text();
                    let json = null;
                    try { json = JSON.parse(text); } catch (e) { /* not JSON */ }

                    console.log('CreateSessionAjax response status:', resp.status, 'body:', text, 'parsed:', json);

                    if (!resp.ok) {
                        // تلاش برای نمایش پیغام کاربرپسند
                        const message = (json && (json.error || json.message)) ? (json.error || json.message) :
                            text || `خطا: status ${resp.status}`;
                        Swal.close();
                        return Swal.fire({ icon: 'error', title: 'خطا در ایجاد جلسه', text: message });
                    }

                    // در صورت بازگشت id، هدایت به جزئیات جلسه
                    if (json && json.id) {
                        Swal.fire({ icon: 'success', title: 'موفق', text: json.message || 'جلسه ایجاد شد.' })
                            .then(() => window.location.href = `/Attendance/SessionDetails/${json.id}`);
                        return;
                    }

                    // fallback: رفرش صفحه
                    Swal.fire({ icon: 'success', title: 'موفق', text: (json && json.message) ? json.message : 'جلسه ایجاد شد.' })
                        .then(() => window.location.reload());
                } catch (err) {
                    console.error('CreateSession unexpected error', err);
                    Swal.close();
                    Swal.fire({ icon: 'error', title: 'خطا', text: 'ایجاد جلسه موفق نبود. جزئیات در کنسول لاگ شد.' });
                }
            });
        })();
    </script>

@*     <script>
        (function () {
            // DOM
            const gradeSelect = document.getElementById('wizard-grade');
            const toStep2Btn = document.getElementById('to-step-2');
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const backBtn = document.getElementById('back-to-step-1');
            const studentsList = document.getElementById('students-list');
            const selectedGradeSpan = document.getElementById('selected-grade');
            const toStep3Btn = document.getElementById('to-step-3');

            function getAntiForgeryToken() {
                const el = document.querySelector('input[name="__RequestVerificationToken"]');
                return el ? el.value : null;
            }

            // Step1 -> fetch students by grade
            toStep2Btn.addEventListener('click', async function () {
                const g = gradeSelect.value;
                if (!g) { Swal.fire({ icon: 'warning', title: 'لطفاً یک پایه انتخاب کنید' }); return; }

                Swal.fire({ title: 'در حال بارگذاری دانش‌آموزان...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
                try {
                    // use Url.Action to build URL server-side then replace placeholder to avoid razor encoding issues
                    const urlTemplate = '@Url.Action("GetStudentsByGrade", "Attendance")?grade=PLACEHOLDER';
                    const url = urlTemplate.replace('PLACEHOLDER', encodeURIComponent(g));

                    const res = await fetch(url, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
                    if (!res.ok) { const txt = await res.text(); console.error('GetStudentsByGrade failed', res.status, txt); throw new Error('بارگذاری دانش‌آموزان موفق نبود'); }
                    const data = await res.json();

                    studentsList.innerHTML = '';
                    data.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-3 p-2 border rounded';
                        div.innerHTML = `
                            <input type="checkbox" class="student-checkbox" value="${s.id}" id="st-${s.id}" checked />
                            <img src="${s.photo || '/uploads/students/default.png'}" class="w-10 h-10 rounded object-cover" alt="photo-${s.id}" />
                            <div class="flex-1">
                                <div class="font-bold">${s.firstName || ''} ${s.lastName || ''}</div>
                                <div class="text-xs text-slate-500">${s.nationalCode || ''}</div>
                            </div>
                        `;
                        studentsList.appendChild(div);
                    });

                    selectedGradeSpan.textContent = g;
                    step1.classList.add('hidden');
                    step2.classList.remove('hidden');
                } catch (err) {
                    console.error(err);
                    Swal.fire({ icon: 'error', title: 'خطا', text: 'بارگذاری لیست دانش‌آموزان ناموفق بود.' });
                } finally {
                    Swal.close();
                }
            });

            backBtn.addEventListener('click', function () {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            });

            // Step2 -> Create (AJAX) : ask both title and location in one modal and post
            toStep3Btn.addEventListener('click', async function () {
                const grade = gradeSelect.value;
                const checked = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(x => parseInt(x.value, 10));

                if (!grade) return Swal.fire({ icon: 'warning', text: 'پایه انتخاب نشده' });
                if (!checked.length) return Swal.fire({ icon: 'warning', text: 'هیچ دانش‌آموزی انتخاب نشده' });

                // create an html form inside swal for Title and Location
                const todayShamsi = (new Date()).toLocaleDateString('fa-IR-u-nu-latn');

                const { value: formValues } = await Swal.fire({
                  title: 'مشخصات جلسه',
                  html:
                    `<input id="swal-title" class="swal2-input" placeholder="نام جلسه">` +
                    `<input id="swal-start" type="time" class="swal2-input" value="">` +
                    `<input id="swal-location" class="swal2-input" placeholder="مکان (اختیاری)">` +
                    `<div class="text-sm mt-1">تاریخ جلسه (شمسی): ${todayShamsi}</div>`,
                  focusConfirm: false,
                  showCancelButton: true,
                  preConfirm: () => {
                    const t = document.getElementById('swal-title')?.value?.trim();
                    const start = document.getElementById('swal-start')?.value;
                    const loc = document.getElementById('swal-location')?.value?.trim();
                    if (!t) {
                      Swal.showValidationMessage('نام جلسه لازم است');
                      return false;
                    }
                    return { title: t, startTime: start || null, location: loc || null, dateShamsi: todayShamsi };
                  }
                });

                if (!formValues) return; // canceled

                const title = formValues.title;
                const dateShamsi = formValues.dateShamsi;
                const startTime = formValues.startTime; // format "HH:mm" or null
                const location = formValues.location;

                const { title, location } = formValues;

                // build form data
                const fd = new FormData();
                fd.append('title', title);
                fd.append('dateShamsi', todayShamsi);
                fd.append('grade', grade);
                fd.append('location', location || '');
                checked.forEach(id => fd.append('studentIds', id.toString()));

                const token = getAntiForgeryToken();
                if (!token) {
                    console.error('Anti-forgery token not found in DOM.');
                    return Swal.fire({ icon: 'error', title: 'خطا', text: 'توکن امنیتی پیدا نشد. صفحه را رفرش کنید و مجدداً تلاش کنید.' });
                }

                Swal.fire({ title: 'در حال ایجاد جلسه...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                try {
                    const postUrl = '@Url.Action("CreateSessionAjax", "Attendance")';

                    const resp = await fetch(postUrl, {
                        method: 'POST',
                        credentials: 'same-origin',
                        body: fd,
                        headers: {
                            'RequestVerificationToken': token
                        }
                    });

                    const text = await resp.text();
                    let json = null;
                    try { json = JSON.parse(text); } catch (e) { /* not json */ }

                    console.log('CreateSessionAjax: sending POST to', postUrl, { grade, countStudents: checked.length });
                    console.log('CreateSessionAjax response:', { status: resp.status, redirected: resp.redirected, url: resp.url, bodyText: text, parsed: json });

                    if (!resp.ok) {
                        const message = (json && (json.error || json.message)) ? (json.error || json.message) : (text || `خطا: ${resp.status}`);
                        Swal.close();
                        return Swal.fire({ icon: 'error', title: 'خطا در ایجاد جلسه', text: message });
                    }

                    if (json && json.id) {
                        Swal.fire({ icon: 'success', title: 'موفق', text: json.message || 'جلسه ایجاد شد.' })
                            .then(() => window.location.href = `/Attendance/SessionDetails/${json.id}`);
                        return;
                    }

                    Swal.fire({ icon: 'success', title: 'موفق', text: (json && json.message) ? json.message : 'جلسه ایجاد شد.' })
                        .then(() => window.location.reload());
                } catch (err) {
                    console.error('CreateSession unexpected error', err);
                    Swal.close();
                    Swal.fire({ icon: 'error', title: 'خطا', text: 'ایجاد جلسه موفق نبود. جزئیات در کنسول لاگ شد.' });
                }
            });

        })();
    </script> *@
}
@{
    ViewData["Title"] = "ایجاد جلسه حضور و غیاب - ویزارد";
    Layout = "_Layout";
}

@{
    var createdSessionId = Context.Request.Query["createdSessionId"].FirstOrDefault();
}

<form id="__antiforgery" style="display:none" method="post" asp-action="CreateSession" asp-controller="Attendance">
    @Html.AntiForgeryToken()
</form>

<div class="bg-white rounded-lg border p-6 space-y-4">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-xl font-bold text-slate-800">مدیریت جلسات</h2>
            <p class="text-sm text-slate-500">مدیریت جلسات حضور و غیاب به صورت مرحله‌ای</p>
        </div>
        <a asp-action="Index" asp-controller="Students"
           class="px-3 py-2 bg-slate-100 rounded hover:bg-slate-200">بازگشت</a>
    </div>

    <hr />

    <!-- STEP 1 -->
    <div id="step-1" class="space-y-4">
        <h3 class="font-bold text-lg">مرحله ۱ — نحوه انتخاب دانش‌آموزان</h3>

        <div class="flex gap-6">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="mode" value="byGrade" checked />
                بر اساس پایه تحصیلی
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="mode" value="all" />
                همه دانش‌آموزان (تمام پایه‌ها)
            </label>
        </div>

        <button id="to-step-2"
                class="bg-green-600 text-white px-4 py-2 rounded">
            ادامه
        </button>
    </div>

    <!-- STEP 2 -->
    <div id="step-2" class="hidden space-y-4">

        <div id="grade-tabs" class="flex gap-2 flex-wrap"></div>

        <div id="students-container" class="grid gap-2"></div>

        <div class="flex gap-4 justify-center">
            <button id="to-step-3"
                    class="bg-green-600 text-white px-4 py-2 rounded">
                ثبت جلسه
            </button>

            <button id="back-to-step-1"
                    class="bg-rose-100 text-rose-700 px-4 py-2 rounded">
                بازگشت
            </button>
        </div>
    </div>
</div>

@section CreateWizardSesstionScripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        (function () {

            /* ================== DOM ================== */
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const toStep2Btn = document.getElementById('to-step-2');
            const toStep3Btn = document.getElementById('to-step-3');
            const backBtn = document.getElementById('back-to-step-1');

            const gradeTabsContainer = document.getElementById('grade-tabs');
            const studentsContainer = document.getElementById('students-container');

            const modeRadios = document.querySelectorAll('input[name="mode"]');

            /* ================== STATE ================== */
            let mode = 'byGrade';              // byGrade | all
            let selectedGrade = null;
            const selectedStudentIds = new Set();
            const cache = {};

            /* ================== AntiForgery ================== */
            function getAntiForgeryToken() {
                const el = document.querySelector('input[name="__RequestVerificationToken"]');
                return el ? el.value : null;
            }

            /* ================== Mode Change ================== */
            modeRadios.forEach(r => {
                r.addEventListener('change', () => {
                    mode = r.value;
                    selectedGrade = null;
                    gradeTabsContainer.innerHTML = '';
                    studentsContainer.innerHTML = '';
                    selectedStudentIds.clear();
                });
            });

            /* ================== Load Grades ================== */
            async function loadGrades() {
                const res = await fetch('@Url.Action("GetGrades", "Attendance")', {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!res.ok) throw new Error();
                return await res.json();
            }

            /* ================== Load Students ================== */
            async function loadStudentsByGrade(grade) {
                if (cache[grade]) return cache[grade];

                const res = await fetch('@Url.Action("GetStudentsByGrade", "Attendance")?grade=' + encodeURIComponent(grade), {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!res.ok) throw new Error();

                const data = await res.json();
                cache[grade] = data;
                return data;
            }

            async function loadAllStudents() {
                if (cache.ALL) return cache.ALL;

                const res = await fetch('@Url.Action("GetAllStudents", "Attendance")', {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!res.ok) throw new Error();

                const data = await res.json();
                cache.ALL = data;
                return data;
            }

            /* ================== Render Tabs ================== */
            function renderGradeTabs(grades) {
                gradeTabsContainer.innerHTML = '';

                grades.forEach(g => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = `پایه ${g}`;
                    btn.className = 'px-3 py-1 rounded bg-slate-100 hover:bg-slate-200';

                    btn.addEventListener('click', async () => {
                        document.querySelectorAll('#grade-tabs button')
                            .forEach(b => b.classList.remove('bg-blue-600', 'text-white'));

                        btn.classList.add('bg-blue-600', 'text-white');
                        selectedGrade = g;

                        const students = await loadStudentsByGrade(g);
                        renderStudents(students);
                    });

                    gradeTabsContainer.appendChild(btn);
                });
            }

            /* ================== Render Students ================== */
            function renderStudents(list) {
                studentsContainer.innerHTML = '';

                list.forEach(s => {
                    const checked = selectedStudentIds.has(s.id);

                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-3 p-2 border rounded cursor-pointer';

                    label.innerHTML = `
                        <input type="checkbox" value="${s.id}" ${checked ? 'checked' : ''} />
                        <img src="${s.photo || '/uploads/students/default.png'}"
                             class="w-10 h-10 rounded object-cover" />
                        <div>
                            <div class="font-bold">${s.firstName} ${s.lastName}</div>
                            <div class="text-xs text-slate-500">${s.nationalCode || ''}</div>
                        </div>
                    `;

                    const cb = label.querySelector('input');
                    cb.addEventListener('change', () => {
                        const id = parseInt(cb.value, 10);
                        cb.checked ? selectedStudentIds.add(id) : selectedStudentIds.delete(id);
                    });

                    studentsContainer.appendChild(label);
                });
            }

            /* ================== Step 1 → Step 2 ================== */
            toStep2Btn.addEventListener('click', async () => {

                Swal.fire({ title: 'در حال آماده‌سازی...', didOpen: () => Swal.showLoading() });

                try {
                    if (mode === 'byGrade') {
                        const grades = await loadGrades();
                        renderGradeTabs(grades);
                    } else {
                        const students = await loadAllStudents();
                        renderStudents(students);
                    }

                    step1.classList.add('hidden');
                    step2.classList.remove('hidden');

                } catch {
                    Swal.fire('خطا', 'دریافت اطلاعات ناموفق بود', 'error');
                } finally {
                    Swal.close();
                }
            });

            /* ================== Back ================== */
            backBtn.addEventListener('click', () => {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            });

            /* ================== Swal: Session Meta ================== */
            async function askSessionMeta() {
                const result = await Swal.fire({
                    title: 'اطلاعات جلسه',
                    html: `
                        <div class="text-right space-y-3">
                            <div>
                                <label class="block text-sm mb-1">مکان برگزاری</label>
                                <input id="swal-location" class="swal2-input" placeholder="مثلاً کلاس ۱۰۱">
                            </div>
                            <div>
                                <label class="block text-sm mb-1">ساعت شروع جلسه</label>
                                <input id="swal-start-time" type="time" step="300" class="swal2-input">
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'تأیید',
                    cancelButtonText: 'انصراف',
                    focusConfirm: false,
                    preConfirm: () => {
                        const location = document.getElementById('swal-location').value.trim();
                        const startTime = document.getElementById('swal-start-time').value;

                        if (!location)
                            Swal.showValidationMessage('مکان برگزاری را وارد کنید');

                        if (!startTime)
                            Swal.showValidationMessage('ساعت شروع جلسه را انتخاب کنید');

                        return { location, startTime };
                    }
                });

                return result.isConfirmed ? result.value : null;
            }

            /* ================== Save ================== */
        toStep3Btn.addEventListener('click', async () => {

            if (!selectedStudentIds.size) {
                return Swal.fire('هشدار', 'هیچ دانش‌آموزی انتخاب نشده', 'warning');
            }

            const sessionIdInput = document.querySelector('input[name="sessionId"]');
            const sessionId = sessionIdInput ? Number(sessionIdInput.value) : 0;

            if (!sessionId) {
                return Swal.fire('خطا', 'شناسه جلسه نامعتبر است', 'error');
            }

            const sessionMeta = await askSessionMeta();
            if (!sessionMeta) return;

            const fd = new FormData();
            fd.append('sessionId', sessionId);

            // 🔴 تطبیق کامل با SaveAttendance
            selectedStudentIds.forEach(id => {
                fd.append('records[]', JSON.stringify({
                    studentId: id,
                    status: null,
                    lateMinutes: null,
                    note: null
                }));
            });

            const anti = getAntiForgeryToken();
            if (anti) fd.append('__RequestVerificationToken', anti);

            Swal.fire({ title: 'در حال ثبت...', didOpen: () => Swal.showLoading() });

            try {
                const res = await fetch('@Url.Action("SaveAttendance", "Attendance")', {
                    method: 'POST',
                    body: fd,
                    credentials: 'same-origin'
                });

                const text = await res.text();
                let parsed = null;
                try { parsed = JSON.parse(text); } catch { }

                if (!res.ok) {
                    console.error('SaveAttendance error:', res.status, parsed || text);
                    throw new Error();
                }

                Swal.fire('موفق', 'جلسه با موفقیت ایجاد شد', 'success');

            } catch {
                Swal.fire('خطا', 'ثبت اطلاعات ناموفق بود', 'error');
            }
        });


        })();
    </script>
}

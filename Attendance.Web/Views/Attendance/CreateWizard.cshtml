@{
    ViewData["Title"] = "ایجاد جلسه حضور و غیاب - ویزارد";
    Layout = "_Layout";
}

@{
    var createdSessionId = Context.Request.Query["createdSessionId"].FirstOrDefault();
}

<form id="__antiforgery" style="display:none" method="post" asp-action="CreateSession" asp-controller="Attendance">
    @Html.AntiForgeryToken()
</form>
<!-- کارت و هدر -->
<div class="bg-white rounded-lg border p-6 space-y-4">
    <div class="flex items-center justify-between gap-4">
        <div>
            <h2 class="text-xl font-bold text-slate-800">ساخت و مدیریت جلسه جدید</h2>
            <p class="text-sm text-slate-500">مدیریت جلسات حضور و غیاب به صورت مرحله‌ای</p>
        </div>
        <div class="flex items-center gap-3">
            <a asp-action="AllSessions" asp-controller="Attendance" class="inline-block px-3 py-2 bg-slate-800 text-slate-100 rounded hover:bg-blue-500 transition">بازگشت به لیست جلسات</a>
        </div>
    </div>
    <hr class="border-slate-200">
    <div class="bg-slate-100/50 rounded-lg border border-dashed p-2">
        <div class="flex-1">
            <div class="flex items-center justify-center grid grid-cols-3 md:grid-cols-1 text-center gap-3 text-sm">
                <!-- STEP 1 -->
                <div id="step-1" class="space-y-4">
                    <h3 class="font-bold text-lg">مرحله ۱ — نحوه انتخاب دانش‌آموزان</h3>

                    <div class="flex gap-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="mode" value="byGrade" checked />
                            بر اساس پایه تحصیلی
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="mode" value="all" />
                            همه دانش‌آموزان (تمام پایه‌ها)
                        </label>
                    </div>

                    <button id="to-step-2"
                            class="bg-green-600 text-white px-4 py-2 rounded">
                        ادامه
                    </button>
                </div>

                <!-- STEP 2 -->
                <div id="step-2" class="hidden space-y-4">
                    <div class="mb-3 text-sm text-slate-700">
                        تعداد دانش آموزان انتخاب شده:       
                        <span id="selected-count" class="font-bold text-blue-600">0</span>
                    </div>

                    <div class="flex gap-2 justify-center mb-3">
                        <button id="select-all"
                                type="button"
                                class="px-3 py-2 bg-slate-200  font-bold  text-sm rounded hover:bg-teal-200">
                            انتخاب همه
                        </button>

                        <button id="deselect-all"
                                type="button"
                                class="px-3 py-2 bg-slate-200 font-bold  text-sm rounded hover:bg-rose-200">
                            لغو همه
                        </button>
                    </div>

                    <div id="grade-tabs" class="grid grid-cols-1 md:grid-cols-3 text-center gap-3 text-sm"></div>

                    <div id="students-container" class="grid grid-cols-1 md:grid-cols-3 text-center gap-3 text-sm"></div>

                    <div class="flex gap-4 justify-center">
                        <button id="to-step-3"
                                class="bg-teal-600 text-white px-4 py-2 rounded">
                            ثبت جلسه
                        </button>

                        <button id="back-to-step-1" class="px-3 py-2 bg-slate-800 text-slate-100 rounded hover:bg-blue-500 transition">
                            انصراف و بازگشت
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section CreateWizardSesstionScripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        (function () {

            /* ================== DOM ================== */
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const toStep2Btn = document.getElementById('to-step-2');
            const toStep3Btn = document.getElementById('to-step-3');
            const backBtn = document.getElementById('back-to-step-1');
            const selectAllBtn = document.getElementById('select-all');
            const deselectAllBtn = document.getElementById('deselect-all');
            const gradeTabsContainer = document.getElementById('grade-tabs');
            const studentsContainer = document.getElementById('students-container');
            const modeRadios = document.querySelectorAll('input[name="mode"]');

            /* ================== STATE ================== */
            let mode = 'byGrade';
            let selectedGrade = null;
            const selectedStudentIds = new Set();
            const cache = {};

            /* ================== AntiForgery ================== */
            function getAntiForgeryToken() {
                const el = document.querySelector('input[name="__RequestVerificationToken"]');
                return el ? el.value : null;
            }

            /* ================== Time Normalizer (FIX اصلی) ================== */
            function normalizeTime(value) {
                if (!value) return null;

                // حذف AM / PM اگر مرورگر اضافه کرده باشد
                value = value.replace(/AM|PM|am|pm/g, '').trim();

                const match = value.match(/^(\d{1,2}):(\d{2})$/);
                if (!match) return null;

                const h = parseInt(match[1], 10);
                const m = parseInt(match[2], 10);

                if (h > 23 || m > 59) return null;

                return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
            }

            /* ================== Mode Change ================== */
            modeRadios.forEach(r => {
                r.addEventListener('change', () => {
                    mode = r.value;
                    selectedGrade = null;
                    gradeTabsContainer.innerHTML = '';
                    studentsContainer.innerHTML = '';
                    selectedStudentIds.clear();
                    updateSelectedCount();
                });
            });

            /* ================== Select / Deselect ================== */
            selectAllBtn.onclick = () => {
                studentsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                    selectedStudentIds.add(Number(cb.value));
                });
                updateSelectedCount();
            };

            deselectAllBtn.onclick = () => {
                studentsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    selectedStudentIds.delete(Number(cb.value));
                });
                updateSelectedCount();
            };

            /* ================== Load Data ================== */
            async function loadGrades() {
                const r = await fetch('@Url.Action("GetGrades", "Attendance")');
                return await r.json();
            }

            async function loadStudentsByGrade(g) {
                if (cache[g]) return cache[g];
                const r = await fetch('@Url.Action("GetStudentsByGrade", "Attendance")?grade=' + encodeURIComponent(g));
                return cache[g] = await r.json();
            }

            async function loadAllStudents() {
                if (cache.ALL) return cache.ALL;
                const r = await fetch('@Url.Action("GetAllStudents", "Attendance")');
                return cache.ALL = await r.json();
            }

            /* ================== Render ================== */
            function renderGradeTabs(grades) {
                gradeTabsContainer.innerHTML = '';
                grades.forEach(g => {
                    const btn = document.createElement('button');
                    btn.textContent = `پایه ${g}`;
                    btn.className = 'px-3 py-1 rounded bg-slate-100 hover:bg-slate-200';
                    btn.onclick = async () => {
                        selectedGrade = g;
                        renderStudents(await loadStudentsByGrade(g));
                    };
                    gradeTabsContainer.appendChild(btn);
                });
            }

            function renderStudents(list) {
                studentsContainer.innerHTML = '';
                list.forEach(s => {
                    const id = Number(s.id);
                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-3 p-2 border border-dashed rounded cursor-pointer';

                    label.innerHTML = `
                        <input type="checkbox" value="${id}">
                        <img src="${s.photo || '/uploads/students/default.png'}" class="w-10 h-10 rounded">
                        <div>
                            <div class="font-bold">${s.firstName} ${s.lastName}</div>
                            <div class="text-xs">${s.nationalCode || ''}</div>
                        </div>
                    `;

                    label.querySelector('input').onchange = e => {
                        e.target.checked ? selectedStudentIds.add(id) : selectedStudentIds.delete(id);
                        updateSelectedCount();
                    };

                    studentsContainer.appendChild(label);
                });
            }

            function updateSelectedCount() {
                const el = document.getElementById('selected-count');
                if (el) el.textContent = selectedStudentIds.size;
            }

            /* ================== Step Navigation ================== */
            toStep2Btn.onclick = async () => {
                Swal.showLoading();
                try {
                    mode === 'byGrade'
                        ? renderGradeTabs(await loadGrades())
                        : renderStudents(await loadAllStudents());

                    step1.classList.add('hidden');
                    step2.classList.remove('hidden');
                } catch {
                    Swal.fire('خطا', 'دریافت اطلاعات ناموفق بود', 'error');
                }
                Swal.close();
            };

            backBtn.onclick = () => {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            };

            /* ================== Swal Meta ================== */
            async function askSessionMeta() {
                const r = await Swal.fire({
                    title: 'اطلاعات جلسه',
                    html: `
                        <input id="session-title" class="swal2-input" placeholder="نام جلسه را وارد نمایید">
                        <input id="session-location" class="swal2-input" placeholder="مکان برگزاری جلسه را وارد نمایید">

                        <div class="flex gap-2 justify-center mt-2">
                            <input id="session-time"
                                   type="text"
                                   class="swal2-input"
                                   style="width:160px;text-align:center"
                                   placeholder="06:30">
                        </div>

                        <div class="flex gap-4 justify-center mt-3">
                            <label><input type="radio" name="session-period" value="Morning"> ☀️ صبح</label>
                            <label><input type="radio" name="session-period" value="Evening"> 🌙 عصر</label>
                        </div>
                    `,
                    preConfirm: () => {
                        const title = document.getElementById('session-title').value.trim();
                        const location = document.getElementById('session-location').value.trim();
                        const rawTime = document.getElementById('session-time').value;
                        const period = document.querySelector('input[name="session-period"]:checked')?.value;

                        const time = normalizeTime(rawTime);

                        if (!title) return Swal.showValidationMessage('نام جلسه الزامی است');
                        if (!location) return Swal.showValidationMessage('مکان جلسه الزامی است');
                        if (!time) return Swal.showValidationMessage('ساعت نامعتبر است (مثلاً 06:30)');
                        if (!period) return Swal.showValidationMessage('صبح یا عصر را انتخاب کنید');

                        return { title, location, startTime: time, period };
                    },
                    showCancelButton: true,
                    confirmButtonText: 'تأیید و ادامه',
                    cancelButtonText: 'انصراف'
                });

                return r.isConfirmed ? r.value : null;
            }

            /* ================== FINAL SAVE ================== */
            toStep3Btn.onclick = async () => {

                if (mode === 'byGrade' && !selectedGrade)
                    return Swal.fire('هشدار', 'پایه تحصیلی انتخاب نشده', 'warning');

                if (!selectedStudentIds.size)
                    return Swal.fire('هشدار', 'هیچ دانش‌آموزی انتخاب نشده', 'warning');

                const meta = await askSessionMeta();
                if (!meta) return;

                const today = new Intl.DateTimeFormat('fa-IR-u-ca-persian',{
                    year:'numeric',month:'2-digit',day:'2-digit'
                }).format(new Date());

                console.log('dateShamsi =>', today);

                // const today = new Intl.DateTimeFormat('fa-IR-u-ca-persian',{
                //     year:'numeric',month:'2-digit',day:'2-digit'
                // }).format(new Date());

                const fd = new FormData();
                fd.append('__RequestVerificationToken', getAntiForgeryToken());
                fd.append('title', meta.title);
                fd.append('dateShamsi', today);
                fd.append('grade', mode === 'byGrade' ? selectedGrade : 'ALL');
                fd.append('period', meta.period);
                fd.append('location', meta.location);
                fd.append('startTime', meta.startTime);

                selectedStudentIds.forEach(id => fd.append('studentIds', id));

                Swal.showLoading();
                const res = await fetch('@Url.Action("CreateSessionAjax", "Attendance")', {
                    method: 'POST',
                    body: fd
                });

                const data = await res.json();
                if (!res.ok) return Swal.fire('خطا', data.error, 'error');

                Swal.fire('موفق', 'جلسه ایجاد شد', 'success')
                    .then(() => location.href = `/Attendance/SessionDetails/${data.id}`);
            };

        })();
    </script>

}

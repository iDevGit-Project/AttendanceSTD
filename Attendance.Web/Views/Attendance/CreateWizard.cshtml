@{
    ViewData["Title"] = "ایجاد جلسه حضور و غیاب - ویزارد";
    Layout = "_Layout";
}

@{
    var createdSessionId = Context.Request.Query["createdSessionId"].FirstOrDefault();
}

<form id="__antiforgery" style="display:none" method="post" asp-action="CreateSession" asp-controller="Attendance">
    @Html.AntiForgeryToken()
</form>

<div class="bg-white rounded-lg border p-6 space-y-4">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-xl font-bold text-slate-800">مدیریت جلسات</h2>
            <p class="text-sm text-slate-500">مدیریت جلسات حضور و غیاب به صورت مرحله‌ای</p>
        </div>
        <a asp-action="Index" asp-controller="Students"
           class="px-3 py-2 bg-slate-100 rounded hover:bg-slate-200">بازگشت</a>
    </div>

    <hr />

    <!-- STEP 1 -->
    <div id="step-1" class="space-y-4">
        <h3 class="font-bold text-lg">مرحله ۱ — نحوه انتخاب دانش‌آموزان</h3>

        <div class="flex gap-6">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="mode" value="byGrade" checked />
                بر اساس پایه تحصیلی
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="mode" value="all" />
                همه دانش‌آموزان (تمام پایه‌ها)
            </label>
        </div>

        <button id="to-step-2"
                class="bg-green-600 text-white px-4 py-2 rounded">
            ادامه
        </button>
    </div>

    <!-- STEP 2 -->
    <div id="step-2" class="hidden space-y-4">

        <div id="grade-tabs" class="flex gap-2 flex-wrap"></div>

        <div id="students-container" class="grid gap-2"></div>

        <div class="flex gap-4 justify-center">
            <button id="to-step-3"
                    class="bg-green-600 text-white px-4 py-2 rounded">
                ثبت جلسه
            </button>

            <button id="back-to-step-1"
                    class="bg-rose-100 text-rose-700 px-4 py-2 rounded">
                بازگشت
            </button>
        </div>
    </div>
</div>

@section CreateWizardSesstionScripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        (function () {
            /* ================== DOM ================== */
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const toStep2Btn = document.getElementById('to-step-2');
            const toStep3Btn = document.getElementById('to-step-3');
            const backBtn = document.getElementById('back-to-step-1');

            const gradeTabsContainer = document.getElementById('grade-tabs');
            const studentsContainer = document.getElementById('students-container');
            const modeRadios = document.querySelectorAll('input[name="mode"]');

            /* ================== STATE ================== */
            let mode = 'byGrade';
            let selectedGrade = null;
            const selectedStudentIds = new Set();
            const cache = {};

            /* ================== AntiForgery ================== */
            function getAntiForgeryToken() {
                const el = document.querySelector('input[name="__RequestVerificationToken"]');
                return el ? el.value : null;
            }

            /* ================== Mode Change ================== */
            modeRadios.forEach(r => {
                r.addEventListener('change', () => {
                    mode = r.value;
                    selectedGrade = null;
                    gradeTabsContainer.innerHTML = '';
                    studentsContainer.innerHTML = '';
                    selectedStudentIds.clear();
                });
            });

            /* ================== Load Grades ================== */
            async function loadGrades() {
                const res = await fetch('@Url.Action("GetGrades", "Attendance")');
                if (!res.ok) throw new Error();
                return await res.json();
            }

            /* ================== Load Students ================== */
            async function loadStudentsByGrade(grade) {
                if (cache[grade]) return cache[grade];
                const res = await fetch('@Url.Action("GetStudentsByGrade", "Attendance")?grade=' + encodeURIComponent(grade));
                if (!res.ok) throw new Error();
                return cache[grade] = await res.json();
            }

            async function loadAllStudents() {
                if (cache.ALL) return cache.ALL;
                const res = await fetch('@Url.Action("GetAllStudents", "Attendance")');
                if (!res.ok) throw new Error();
                return cache.ALL = await res.json();
            }

            /* ================== Render Tabs ================== */
            function renderGradeTabs(grades) {
                gradeTabsContainer.innerHTML = '';
                grades.forEach(g => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = `پایه ${g}`;
                    btn.className = 'px-3 py-1 rounded bg-slate-100 hover:bg-slate-200';
                    btn.onclick = async () => {
                        selectedGrade = g;
                        const students = await loadStudentsByGrade(g);
                        renderStudents(students);
                    };
                    gradeTabsContainer.appendChild(btn);
                });
            }

            /* ================== Render Students ================== */
                function renderStudents(list) {
                    studentsContainer.innerHTML = '';

                    list.forEach(s => {
                        const studentId = Number(s.id); // 🔴 اجبار به number

                        const checked = selectedStudentIds.has(studentId);

                        const label = document.createElement('label');
                        label.className = 'flex items-center gap-3 p-2 border rounded cursor-pointer';

                        label.innerHTML = `
                            <input type="checkbox" value="${studentId}" ${checked ? 'checked' : ''} />
                            <img src="${s.photo || '/uploads/students/default.png'}"
                                 class="w-10 h-10 rounded object-cover" />
                            <div>
                                <div class="font-bold">${s.firstName} ${s.lastName}</div>
                                <div class="text-xs text-slate-500">${s.nationalCode || ''}</div>
                            </div>
                        `;

                        const cb = label.querySelector('input');

                        cb.addEventListener('change', () => {
                            const id = Number(cb.value);
                            if (cb.checked) {
                                selectedStudentIds.add(id);
                            } else {
                                selectedStudentIds.delete(id);
                            }
                        });

                        studentsContainer.appendChild(label);
                    });
                }

            /* ================== Step 1 → Step 2 ================== */
            toStep2Btn.onclick = async () => {
                Swal.showLoading();
                try {
                    if (mode === 'byGrade') renderGradeTabs(await loadGrades());
                    else renderStudents(await loadAllStudents());
                    step1.classList.add('hidden');
                    step2.classList.remove('hidden');
                } catch {
                    Swal.fire('خطا', 'دریافت اطلاعات ناموفق بود', 'error');
                }
                Swal.close();
            };

            backBtn.onclick = () => {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            };

            /* ================== Swal Meta ================== */
            async function askSessionMeta() {
                const r = await Swal.fire({
                    title: 'اطلاعات جلسه',
                    html: `
                        <input id="loc" class="swal2-input" placeholder="مکان">
                        <input id="time" type="time" class="swal2-input">
                    `,
                    preConfirm: () => ({
                        location: document.getElementById('loc').value,
                        startTime: document.getElementById('time').value
                    }),
                    showCancelButton: true
                });
                return r.isConfirmed ? r.value : null;
            }

            /* ================== FINAL SAVE ================== */
            toStep3Btn.onclick = async () => {
                if (!selectedStudentIds.size)
                    return Swal.fire('هشدار', 'دانش‌آموزی انتخاب نشده', 'warning');

                const meta = await askSessionMeta();
                if (!meta) return;

                function getTodayShamsi() {
                    const today = new Date();
                    return new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    }).format(today).replace(/\/+/g, '/');
                }

                // ...
                const fd = new FormData();
                fd.append('__RequestVerificationToken', getAntiForgeryToken());
                fd.append('title', 'جلسه حضور و غیاب');
                fd.append('dateShamsi', getTodayShamsi());
                fd.append('grade', mode === 'byGrade' ? selectedGrade : 'ALL');
                fd.append('location', meta.location);
                fd.append('startTime', meta.startTime);

                selectedStudentIds.forEach(id => fd.append('studentIds', id));

                Swal.showLoading();

                const res = await fetch('@Url.Action("CreateSessionAjax", "Attendance")', {
                    method: 'POST',
                    body: fd
                });

                const data = await res.json();
                if (!res.ok) return Swal.fire('خطا', data.error || 'ناموفق', 'error');

                Swal.fire('موفق', 'جلسه ایجاد شد', 'success')
                    .then(() => location.href = `/Attendance/SessionDetails/${data.id}`);
            };
        })();
    </script>

}

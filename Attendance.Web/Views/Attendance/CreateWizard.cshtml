@{
    ViewData["Title"] = "ایجاد جلسه حضور و غیاب - ویزارد";
    Layout = "_Layout";
}

@{
    var createdSessionId = Context.Request.Query["createdSessionId"].FirstOrDefault();
}

<form id="__antiforgery" style="display:none" method="post" asp-action="CreateSession" asp-controller="Attendance">
    @Html.AntiForgeryToken()
</form>

<div class="bg-white rounded-lg border p-6 space-y-4">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-xl font-bold text-slate-800">مدیریت جلسات</h2>
            <p class="text-sm text-slate-500">مدیریت جلسات حضور و غیاب به صورت مرحله‌ای</p>
        </div>
        <a asp-action="Index" asp-controller="Students"
           class="px-3 py-2 bg-slate-100 rounded hover:bg-slate-200">بازگشت</a>
    </div>

    <hr />

    <!-- STEP 1 -->
    <div id="step-1" class="space-y-4">
        <h3 class="font-bold text-lg">مرحله ۱ — نحوه انتخاب دانش‌آموزان</h3>

        <div class="flex gap-6">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="mode" value="byGrade" checked />
                بر اساس پایه تحصیلی
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="mode" value="all" />
                همه دانش‌آموزان (تمام پایه‌ها)
            </label>
        </div>

        <button id="to-step-2"
                class="bg-green-600 text-white px-4 py-2 rounded">
            ادامه
        </button>
    </div>

    <!-- STEP 2 -->
    <div id="step-2" class="hidden space-y-4">

        <div id="grade-tabs" class="flex gap-2 flex-wrap"></div>

        <div id="students-container" class="grid gap-2"></div>

        <div class="flex gap-4 justify-center">
            <button id="to-step-3"
                    class="bg-green-600 text-white px-4 py-2 rounded">
                ثبت جلسه
            </button>

            <button id="back-to-step-1"
                    class="bg-rose-100 text-rose-700 px-4 py-2 rounded">
                بازگشت
            </button>
        </div>
    </div>
</div>

@section CreateWizardSesstionScripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        (function () {

            /* ================== DOM ================== */
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const toStep2Btn = document.getElementById('to-step-2');
            const toStep3Btn = document.getElementById('to-step-3');
            const backBtn = document.getElementById('back-to-step-1');
            const studentsList = document.getElementById('students-list');
            const selectedGradeSpan = document.getElementById('selected-grade');

            /* ================== STATE ================== */
            let selectedGrade = null;              // پایه انتخاب‌شده یا ALL
            const allStudentsCache = {};           // cache per grade
            const selectedStudentIds = new Set();  // ⭐ نگهداری وضعیت انتخاب‌ها

            /* ================== AntiForgery ================== */
            function getAntiForgeryToken() {
                const el = document.querySelector('input[name="__RequestVerificationToken"]');
                return el ? el.value : null;
            }

            /* ================== Grade Tabs ================== */
            document.querySelectorAll('.grade-tab').forEach(btn => {
                btn.addEventListener('click', function () {

                    document.querySelectorAll('.grade-tab').forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white');
                        b.classList.add('bg-slate-100', 'text-slate-700');
                    });

                    this.classList.add('bg-blue-600', 'text-white');
                    this.classList.remove('bg-slate-100', 'text-slate-700');

                    selectedGrade = this.dataset.grade;
                });
            });

            /* ================== Render Students ================== */
            function renderStudents(list) {
                studentsList.innerHTML = '';

                list.forEach(s => {

                    const isChecked =
                        selectedStudentIds.size === 0 || selectedStudentIds.has(s.id);

                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-2 border rounded';

                    div.innerHTML = `
                        <label class="flex items-center gap-3 w-full cursor-pointer">
                            <input type="checkbox"
                                   class="student-checkbox"
                                   value="${s.id}"
                                   ${isChecked ? 'checked' : ''} />
                            <img src="${s.photo || '/uploads/students/default.png'}"
                                 class="w-10 h-10 rounded object-cover" />
                            <div class="flex-1">
                                <div class="font-bold">${s.firstName || ''} ${s.lastName || ''}</div>
                                <div class="text-xs text-slate-500">${s.nationalCode || ''}</div>
                            </div>
                        </label>
                    `;

                    const checkbox = div.querySelector('.student-checkbox');

                    checkbox.addEventListener('change', () => {
                        const id = parseInt(checkbox.value, 10);
                        if (checkbox.checked) {
                            selectedStudentIds.add(id);
                        } else {
                            selectedStudentIds.delete(id);
                        }
                    });

                    studentsList.appendChild(div);
                });
            }

            /* ================== Step 1 → Step 2 ================== */
            toStep2Btn.addEventListener('click', async function () {

                if (!selectedGrade) {
                    return Swal.fire({
                        icon: 'warning',
                        title: 'انتخاب الزامی است',
                        text: 'لطفاً یکی از گزینه‌ها را انتخاب کنید'
                    });
                }

                Swal.fire({
                    title: 'در حال بارگذاری دانش‌آموزان...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    if (!allStudentsCache[selectedGrade]) {

                        let url = '';
                        if (selectedGrade === 'ALL') {
                            url = '@Url.Action("GetAllStudents", "Attendance")';
                            selectedGradeSpan.textContent = 'همه دانش‌آموزان';
                        } else {
                            const tpl = '@Url.Action("GetStudentsByGrade", "Attendance")?grade=__GRADE__';
                            url = tpl.replace('__GRADE__', encodeURIComponent(selectedGrade));
                            selectedGradeSpan.textContent = `پایه ${selectedGrade}`;
                        }

                        const res = await fetch(url, {
                            method: 'GET',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' },
                            credentials: 'same-origin'
                        });

                        if (!res.ok) throw new Error();

                        allStudentsCache[selectedGrade] = await res.json();
                    }

                    renderStudents(allStudentsCache[selectedGrade]);

                    step1.classList.add('hidden');
                    step2.classList.remove('hidden');

                } catch {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطا',
                        text: 'بارگذاری لیست دانش‌آموزان ناموفق بود'
                    });
                } finally {
                    Swal.close();
                }
            });

            /* ================== Back ================== */
            backBtn.addEventListener('click', function () {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            });

            /* ================== Step 2 → Create Session ================== */
            toStep3Btn.addEventListener('click', async function () {

                const checkedIds = Array.from(selectedStudentIds);

                if (!checkedIds.length) {
                    return Swal.fire({
                        icon: 'warning',
                        title: 'هیچ دانش‌آموزی انتخاب نشده'
                    });
                }

                const todayShamsi = (new Date()).toLocaleDateString('fa-IR-u-nu-latn');

                const { value: form } = await Swal.fire({
                    title: 'مشخصات جلسه',
                    html:
                        `<input id="sw-title" class="swal2-input" placeholder="نام جلسه">` +
                        `<div class="flex gap-2">
                            <input id="sw-time" type="time" class="swal2-input" style="width:50%">
                            <input id="sw-loc" class="swal2-input" style="width:50%" placeholder="مکان (اختیاری)">
                         </div>
                         <div class="text-sm mt-1">تاریخ (شمسی): ${todayShamsi}</div>`,
                    showCancelButton: true,
                    focusConfirm: false,
                    preConfirm: () => {
                        const t = document.getElementById('sw-title').value.trim();
                        if (!t) {
                            Swal.showValidationMessage('نام جلسه الزامی است');
                            return false;
                        }
                        return {
                            title: t,
                            startTime: document.getElementById('sw-time').value || null,
                            location: document.getElementById('sw-loc').value || null
                        };
                    }
                });

                if (!form) return;

                const fd = new FormData();
                fd.append('title', form.title);
                fd.append('dateShamsi', todayShamsi);
                fd.append('grade', selectedGrade);
                if (form.startTime) fd.append('startTime', form.startTime);
                if (form.location) fd.append('location', form.location);

                checkedIds.forEach(id => fd.append('studentIds', id));

                const anti = getAntiForgeryToken();
                if (anti) fd.append('__RequestVerificationToken', anti);

                Swal.fire({
                    title: 'در حال ایجاد جلسه...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    const resp = await fetch('@Url.Action("CreateSessionAjax", "Attendance")', {
                        method: 'POST',
                        credentials: 'same-origin',
                        body: fd
                    });

                    const text = await resp.text();
                    let json = null;
                    try { json = JSON.parse(text); } catch {}

                    if (!resp.ok) {
                        Swal.close();
                        return Swal.fire({
                            icon: 'error',
                            title: 'خطا',
                            text: json?.error || json?.message || 'ایجاد جلسه ناموفق بود'
                        });
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'موفق',
                        text: json?.message || 'جلسه با موفقیت ایجاد شد'
                    }).then(() => {
                        if (json?.id) {
                            window.location.href = `/Attendance/SessionDetails/${json.id}`;
                        } else {
                            window.location.reload();
                        }
                    });

                } catch (e) {
                    console.error(e);
                    Swal.fire({ icon: 'error', title: 'خطای غیرمنتظره' });
                }
            });

        })();
    </script>

}

@model Attendance.Data.VModels.StudentCreateViewModel
<!-- کارت و هدر -->
<div class="bg-white rounded-lg border p-6 space-y-4">
    <div class="flex items-center justify-between gap-4">
        <div>
            <h2 class="text-xl font-bold text-slate-800 mb-3">ثبت اطلاعات دانش آموز جدید</h2>
            <p class="text-sm text-slate-500">فرم ثبت نام دانش آموز جدید</p>
        </div>
        <div class="flex items-center gap-3">
            <a asp-action="Index" asp-controller="Students" class="inline-block px-3 py-2 bg-slate-100 font-bold text-slate-800 rounded hover:bg-slate-200 transition">
                انصراف و بازگشت
            </a>
        </div>
    </div>
    <hr class="border-slate-200">
    <div asp-validation-summary="ModelOnly" class="mb-4 text-sm text-rose-700"></div>
    <form asp-action="Create" asp-controller="Students" method="post" enctype="multipart/form-data" class="space-y-6 bg-white">
        <div>
            <h2 class="text-lg px-3 py-1 font-bold rounded-lg text-center text-slate-400 bg-slate-100">فرم ثبت نام دانش آموز جدید</h2>
        </div>
        <div class="bg-slate-100/50 rounded-lg border border-dashed p-4">
            <div class="flex-1">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- FirstName -->
                    <div>
                        <label asp-for="FirstName" class="block text-sm font-bold text-slate-700"></label>
                        <input asp-for="FirstName" class="mt-1 block w-full rounded border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-200" />
                        <span asp-validation-for="FirstName" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>

                    <!-- LastName -->
                    <div>
                        <label asp-for="LastName" class="block text-sm font-bold text-slate-700"></label>
                        <input asp-for="LastName" class="mt-1 block w-full rounded border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-200" />
                        <span asp-validation-for="LastName" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>

                    <!-- BirthDate (Shamsi) -->
                    <div>
                        <label asp-for="BirthDateShamsi" class="block text-sm font-bold text-slate-700">تاریخ تولد (شمسی)</label>
                        <input asp-for="BirthDateShamsi" type="text"
                               class="mt-1 block w-full rounded border px-3 py-2 text-center focus:outline-none focus:ring-2 focus:ring-teal-200"
                               placeholder="مثلاً 1389/02/25"
                               autocomplete="off" />
                        <span asp-validation-for="BirthDateShamsi" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>

                    <!-- EntryDate (Shamsi) -->
                    <div>
                        <label asp-for="EntryDateShamsi" class="block text-sm font-bold text-slate-700">تاریخ ورود به طرح (شمسی)</label>
                        <input asp-for="EntryDateShamsi" type="text"
                               class="mt-1 block w-full rounded border px-3 py-2 text-center focus:outline-none focus:ring-2 focus:ring-teal-200"
                               placeholder="مثلاً 1403/07/01"
                               autocomplete="off" />
                        <span asp-validation-for="EntryDateShamsi" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>

                    <!-- FatherName -->
                    <div>
                        <label asp-for="FatherName" class="block text-sm font-bold text-slate-700"></label>
                        <input asp-for="FatherName" class="mt-1 block w-full rounded border px-3 py-2" />
                        <span asp-validation-for="FatherName" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>

                    <!-- NationalCode -->
                    <div>
                        <label asp-for="NationalCode" class="block text-sm font-bold text-slate-700"></label>
                        <input asp-for="NationalCode" class="mt-1 block w-full rounded border px-3 py-2" />
                        <span asp-validation-for="NationalCode" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>

                    <!-- SchoolName (span full) -->
                    <div class="md:col-span-3">
                        <label asp-for="SchoolName" class="block text-sm font-bold text-slate-700"></label>
                        <input asp-for="SchoolName" class="mt-1 block w-full rounded border px-3 py-2" />
                        <span asp-validation-for="SchoolName" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>

                    <!-- Grade -->
                    <div>
                        <label asp-for="Grade" class="block text-sm font-bold text-slate-700"></label>
                        <input asp-for="Grade" class="mt-1 block w-full rounded border px-3 py-2" />
                        <span asp-validation-for="Grade" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>

                    <!-- CoachName -->
                    <div>
                        <label asp-for="CoachName" class="block text-sm font-bold text-slate-700"></label>
                        <input asp-for="CoachName" class="mt-1 block w-full rounded border px-3 py-2" />
                        <span asp-validation-for="CoachName" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>

                    <!-- WorkgroupName -->
                    <div>
                        <label asp-for="WorkgroupName" class="block text-sm font-bold text-slate-700"></label>
                        <input asp-for="WorkgroupName" class="mt-1 block w-full rounded border px-3 py-2" />
                        <span asp-validation-for="WorkgroupName" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <h2 class="text-lg px-3 py-1 font-bold rounded-lg text-center text-slate-400 bg-slate-100">ثبت فرم های دانش آموز</h2>
        </div>
        <div class="bg-slate-100/50 rounded-lg border border-dashed p-4">
            <div class="flex-1">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <!-- نمایش داده های لیست های کشویی-->
                    <!-- FormStatus fields (selects) -->
                    <div>
                        <label asp-for="ConsentForm" class="block text-sm font-bold text-slate-700">فرم تعهدنامه</label>
                        <select asp-for="ConsentForm" class="mt-1 block w-full rounded border px-3 py-2">
                            <option value="0">تکمیل نشده</option>
                            <option value="1">تکمیل شده</option>
                        </select>
                    </div>

                    <div>
                        <label asp-for="StudentInterviewForm" class="block text-sm font-bold text-slate-700">فرم مصاحبه دانش‌آموز</label>
                        <select asp-for="StudentInterviewForm" class="mt-1 block w-full rounded border px-3 py-2">
                            <option value="0">تکمیل نشده</option>
                            <option value="1">تکمیل شده</option>
                        </select>
                    </div>

                    <div>
                        <label asp-for="ParentInterviewForm" class="block text-sm font-bold text-slate-700">فرم مصاحبه والدین</label>
                        <select asp-for="ParentInterviewForm" class="mt-1 block w-full rounded border px-3 py-2">
                            <option value="0">تکمیل نشده</option>
                            <option value="1">تکمیل شده</option>
                        </select>
                    </div>

                    <div>
                        <label asp-for="TalentTest" class="block text-sm font-bold text-slate-700">آزمون استعدادیابی</label>
                        <select asp-for="TalentTest" class="mt-1 block w-full rounded border px-3 py-2">
                            <option value="0">تکمیل نشده</option>
                            <option value="1">تکمیل شده</option>
                        </select>
                    </div>

                    <div>
                        <label asp-for="PsychologyForm" class="block text-sm font-bold text-slate-700">فرم روانشناسی</label>
                        <select asp-for="PsychologyForm" class="mt-1 block w-full rounded border px-3 py-2">
                            <option value="0">تکمیل نشده</option>
                            <option value="1">تکمیل شده</option>
                        </select>
                    </div>

                    <div>
                        <label asp-for="IQTest" class="block text-sm font-bold text-slate-700">آزمون هوش</label>
                        <select asp-for="IQTest" class="mt-1 block w-full rounded border px-3 py-2">
                            <option value="0">تکمیل نشده</option>
                            <option value="1">تکمیل شده</option>
                        </select>
                    </div>

                    <div>
                        <label asp-for="WarkTest" class="block text-sm font-bold text-slate-700">آزمون وارک</label>
                        <select asp-for="WarkTest" class="mt-1 block w-full rounded border px-3 py-2">
                            <option value="0">تکمیل نشده</option>
                            <option value="1">تکمیل شده</option>
                        </select>
                    </div>
                    <!-- 

                    -->
                    <div>
                        <label asp-for="PaymentStatus" class="block text-sm font-bold text-slate-700">وضعیت پرداخت شهریه</label>
                        <select asp-for="PaymentStatus" class="mt-1 block w-full rounded border px-3 py-2">
                            <option value="0">پرداخت نشده</option>
                            <option value="1">پرداخت شده</option>
                            <option value="2">در حال پرداخت</option>
                        </select>
                        <span asp-validation-for="PaymentStatus" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <h2 class="text-lg px-3 py-1 font-bold rounded-lg text-center text-slate-400 bg-slate-100">فعالسازی دانش آموز در سیستم</h2>
        </div>
        <div class="bg-slate-100/50 rounded-lg border border-dashed p-4">
            <div class="flex flex-wrap items-center gap-6">
                <!-- فعال بودن دانش‌آموز -->
                <div class="flex items-center gap-2">
                    <input asp-for="IsActive" type="checkbox" class="h-4 w-4" />
                    <label asp-for="IsActive" class="text-sm text-slate-700">دانش آموز فعال باشد؟</label>
                </div>
            </div>
        </div>
        <div>
            <h2 class="text-lg px-3 py-1 font-bold rounded-lg text-center text-slate-400 bg-slate-100">ثبت تصویر دانش آموز</h2>
        </div>
        <div class="bg-slate-100/50 rounded-lg border border-dashed p-4">
            <div class="flex flex-wrap items-center justify-center gap-6">
                <!-- دکمه انتخاب تصویر -->
                <div class="flex items-center gap-3">
                    <!-- دکمه آپلود -->
                    <label for="photoInput"
                           class="cursor-pointer inline-flex items-center border px-4 py-2 text-slate-800 bg-slate-50 hover:bg-slate-200 text-sm font-bold rounded transition">
                        انتخاب و بارگذاری تصویر
                    </label>

                    <!-- نام فایل -->
                    <span id="fileName" class="text-sm text-slate-400">هیچ فایلی انتخاب نشده</span>

                    <!-- ورودی فایل مخفی -->
                    <input id="photoInput"
                           asp-for="Photo"
                           type="file"
                           accept="image/*"
                           class="hidden" />
                </div>
                <!-- پیش‌نمایش تصویر -->
                <div class="flex items-center gap-2">
                    <img id="photoPreview" src="/uploads/students/default.png" alt="پیش نمایش عکس" class="w-28 h-28 object-cover rounded border" width="64" />
                    <div class="flex-1">
                        <span asp-validation-for="Photo" class="text-rose-600 text-sm mt-1 block"></span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Action buttons -->
        <div class="flex items-center justify-center gap-4 mt-6">
            <div class="flex items-center aligap-3">
                <button type="submit" class="inline-block bg-green-600 text-slate-100 px-3 py-2 rounded hover:bg-green-700 transition">ثبت اطلاعات دانش آموز</button>
            </div>
            <div>
                <a asp-action="Index" class="inline-block px-3 py-2 bg-slate-100 font-bold text-slate-800 rounded hover:bg-slate-200 transition">انصراف و بازگشت</a>
            </div>
        </div>
        <!-- Hidden inputs to carry parsed year/month/day to server -->
        <input type="hidden" name="BirthYear" id="BirthYear" value="" />
        <input type="hidden" name="BirthMonth" id="BirthMonth" value="" />
        <input type="hidden" name="BirthDay" id="BirthDay" value="" />

        <input type="hidden" name="EntryYear" id="EntryYear" value="" />
        <input type="hidden" name="EntryMonth" id="EntryMonth" value="" />
        <input type="hidden" name="EntryDay" id="EntryDay" value="" />
    </form>
</div>

<partial name="_ValidationScriptsPartial" />
@section CreateStudentsScripts {
    <script>
        /* ===== Image preview (with client-side validation) ===== */
        (function () {
          const input = document.getElementById('photoInput');
          const preview = document.getElementById('photoPreview');
          if (!input || !preview) return;

          input.addEventListener('change', function () {
            const file = this.files && this.files[0];
            if (!file) {
              preview.src = '/uploads/students/default.png';
              return;
            }

            // basic type check
            if (!file.type || !file.type.startsWith('image/')) {
              showLocalNotify('فایل انتخاب شده یک تصویر نیست.', 'error');
              this.value = '';
              preview.src = '/uploads/students/default.png';
              return;
            }

            // size check (2MB)
            const MAX_BYTES = 2 * 1024 * 1024;
            if (file.size > MAX_BYTES) {
              showLocalNotify('حجم تصویر بیش از حد مجاز است (حداکثر 2MB).', 'error');
              this.value = '';
              preview.src = '/uploads/students/default.png';
              return;
            }

            const reader = new FileReader();
            reader.addEventListener('load', function (ev) {
              // set preview to data URL
              preview.src = ev.target.result;
            });
            reader.addEventListener('error', function () {
              showLocalNotify('خطا هنگام خواندن فایل تصویر.', 'error');
              preview.src = '/uploads/students/default.png';
            });
            reader.readAsDataURL(file);
          }, { passive: true });
        })();

        /* ===== Lightweight notify wrapper that prefers the global showNotify ===== */
        function showLocalNotify(message, type = 'success', opts = {}) {
          if (!message) return;

          // prefer global site-wide notify if available
          if (window.showNotify && typeof window.showNotify === 'function') {
            try {
              window.showNotify(message, type, opts);
              return;
            } catch (e) {
              // fall through to fallback if global throws
              console.error('showNotify global error:', e);
            }
          }

          // fallback simple notification (slide-from-top-like)
          (function createFallback() {
            const containerId = 'fallback-notify-container';
            let container = document.getElementById(containerId);
            if (!container) {
              container = document.createElement('div');
              container.id = containerId;
              container.style.position = 'fixed';
              container.style.top = '12px';
              container.style.left = '50%';
              container.style.transform = 'translateX(-50%)';
              container.style.zIndex = '99999';
              container.style.pointerEvents = 'none';
              document.body.appendChild(container);
            }

            const box = document.createElement('div');
            box.setAttribute('role', 'status');
            box.style.pointerEvents = 'auto';
            box.style.minWidth = '260px';
            box.style.maxWidth = '720px';
            box.style.margin = '6px 0';
            box.style.borderRadius = '10px';
            box.style.padding = '12px 18px';
            box.style.display = 'flex';
            box.style.alignItems = 'center';
            box.style.gap = '8px';
            box.style.color = '#fff';
            box.style.boxShadow = '0 10px 30px rgba(0,0,0,0.15)';
            box.style.opacity = '0';
            box.style.transform = 'translateY(-18px) scale(.98)';
            box.style.transition = 'transform 320ms cubic-bezier(.2,.9,.2,1), opacity 320ms ease';
            box.style.fontFamily = 'inherit';
            box.style.fontSize = '14px';
            box.style.lineHeight = '1.4';
            box.style.wordBreak = 'break-word';

            if (type === 'error') box.style.background = '#dc3545';
            else if (type === 'info') box.style.background = '#374151';
            else box.style.background = '#059669';

            box.textContent = message;

            // insert on top
            if (container.firstChild) container.insertBefore(box, container.firstChild);
            else container.appendChild(box);

            // animate in
            requestAnimationFrame(() => {
              box.style.opacity = '1';
              box.style.transform = 'translateY(0) scale(1)';
            });

            // auto-dismiss
            let timeout = setTimeout(close, (opts.timeout || 3500));

            // pause on hover
            box.addEventListener('mouseenter', () => {
              if (timeout) { clearTimeout(timeout); timeout = null; }
              box.style.transform = 'translateY(0) scale(1.02)';
            });
            box.addEventListener('mouseleave', () => {
              if (!timeout) timeout = setTimeout(close, 1800);
              box.style.transform = 'translateY(0) scale(1)';
            });

            function close() {
              box.style.opacity = '0';
              box.style.transform = 'translateY(-14px) scale(.98)';
              setTimeout(() => {
                try { box.remove(); } catch (e) {}
              }, 320);
            }
          })();
        }

        /* ===== Read TempData safely (JSON-serialized on server) and show notify ===== */
        (function () {
          // use JSON serialization on server to avoid HTML-encoding issues
          const successMsg = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["SuccessMessage"] ?? ""));
          const errorMsg = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["ErrorMessage"] ?? ""));

          if (successMsg) {
            showLocalNotify(successMsg, 'success', { timeout: 1800 });
          } else if (errorMsg) {
            showLocalNotify(errorMsg, 'error', { timeout: 3000 });
          }
        })();
    </script>
    <script>
        (function () {
          // helpers
          function showInlineError(msg) {
            // try to show using existing notify, fallback to alert
            if (window.showNotify && typeof window.showNotify === 'function') {
              window.showNotify(msg, 'error');
              return;
            }
            alert(msg);
          }

          // parse "YYYY/MM/DD" -> { year, month, day } or null if invalid
          function parseShamsiString(sh) {
            if (!sh || typeof sh !== 'string') return null;
            // allow full-width slashes just in case, normalize
            sh = sh.replace(/[\uFF0F\u2215]/g, '/').trim();
            const m = sh.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
            if (!m) return null;
            const y = parseInt(m[1], 10);
            const mo = parseInt(m[2], 10);
            const d = parseInt(m[3], 10);
            if (isNaN(y) || isNaN(mo) || isNaN(d)) return null;
            // basic range checks for month/day (we keep conservative validation;
            // fine-grained month/day validity (leap years) can be validated server-side)
            if (mo < 1 || mo > 12) return null;
            if (d < 1 || d > 31) return null;
            return { year: y, month: mo, day: d };
          }

          // main wiring
          document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('form[asp-action="Create"], form[action*="/Students/Create"]') || document.querySelector('form');
            if (!form) return;

            const birthInput = document.querySelector('input[name="BirthDateShamsi"], input[id="BirthDateShamsi"], input[asp-for="BirthDateShamsi"]');
            const entryInput = document.querySelector('input[name="EntryDateShamsi"], input[id="EntryDateShamsi"], input[asp-for="EntryDateShamsi"]');

            const hBirthY = document.getElementById('BirthYear');
            const hBirthM = document.getElementById('BirthMonth');
            const hBirthD = document.getElementById('BirthDay');

            const hEntryY = document.getElementById('EntryYear');
            const hEntryM = document.getElementById('EntryMonth');
            const hEntryD = document.getElementById('EntryDay');

            form.addEventListener('submit', function (ev) {
              // reset hidden fields by default
              if (hBirthY) hBirthY.value = '';
              if (hBirthM) hBirthM.value = '';
              if (hBirthD) hBirthD.value = '';

              if (hEntryY) hEntryY.value = '';
              if (hEntryM) hEntryM.value = '';
              if (hEntryD) hEntryD.value = '';

              // handle birth date if present
              if (birthInput && birthInput.value && birthInput.value.trim() !== '') {
                const parsed = parseShamsiString(birthInput.value.trim());
                if (!parsed) {
                  ev.preventDefault();
                  showInlineError('فرمت تاریخ تولد نامعتبر است — از قالب YYYY/MM/DD استفاده کنید (مثال: 1389/02/25).');
                  birthInput.focus();
                  return false;
                }
                if (hBirthY) hBirthY.value = parsed.year;
                if (hBirthM) hBirthM.value = parsed.month;
                if (hBirthD) hBirthD.value = parsed.day;
              }

              // handle entry date if present
              if (entryInput && entryInput.value && entryInput.value.trim() !== '') {
                const parsed2 = parseShamsiString(entryInput.value.trim());
                if (!parsed2) {
                  ev.preventDefault();
                  showInlineError('فرمت تاریخ ورود به طرح نامعتبر است — از قالب YYYY/MM/DD استفاده کنید (مثال: 1403/07/01).');
                  entryInput.focus();
                  return false;
                }
                if (hEntryY) hEntryY.value = parsed2.year;
                if (hEntryM) hEntryM.value = parsed2.month;
                if (hEntryD) hEntryD.value = parsed2.day;
              }

              // allow submit to continue
              return true;
            }, { passive: false });
          });
        })();
    </script>
    <!-- Simple Persian (Shamsi) DatePicker (no external libs) -->
    <style>
        /* small styles for the floating picker */
        .sh-datepicker {
            position: absolute;
            z-index: 999999;
            background: white;
            border: 1px solid rgba(15,23,42,0.06);
            box-shadow: 0 8px 24px rgba(2,6,23,0.08);
            padding: 10px;
            border-radius: 8px;
            min-width: 260px;
            direction: rtl;
            font-family: inherit;
            font-size: 14px;
        }

            .sh-datepicker .row {
                display: flex;
                gap: 8px;
                align-items: center;
                margin-bottom: 8px;
            }

            .sh-datepicker select {
                flex: 1;
                padding: 6px 8px;
                border-radius: 6px;
                border: 1px solid #e5e7eb;
                background: #fff;
            }

            .sh-datepicker .actions {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 6px;
            }

            .sh-datepicker button {
                padding: 6px 10px;
                border-radius: 6px;
                border: 0;
                cursor: pointer;
                font-weight: 600;
            }

            .sh-datepicker .btn-ok {
                background: #0ea5a0;
                color: white;
            }

            .sh-datepicker .btn-cancel {
                background: #f3f4f6;
                color: #0f172a;
            }
    </style>
    <script>
        (function () {
          // config: year range (shamsi)
          const DEFAULT_YEAR_FROM = 1370;
          const DEFAULT_YEAR_TO_OFFSET = 0; // offset from current shamsi year; 0 -> up to current year

          // helpers
          function pad(n){ return n < 10 ? '0' + n : String(n); }
          function parseShamsiString(sh){
            if (!sh) return null;
            sh = sh.replace(/[\uFF0F\u2215]/g,'/').trim();
            const m = sh.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
            if (!m) return null;
            return { year: parseInt(m[1],10), month: parseInt(m[2],10), day: parseInt(m[3],10) };
          }
          function getCurrentShamsiYear() {
            // Simple conversion using Date -> toLocaleDateString with fa-IR if available in browser:
            try {
              const dt = new Date();
              // Some browsers support toLocaleDateString with 'fa-IR' and numeric year as part; we extract year.
              const s = dt.toLocaleDateString('fa-IR-u-nu-latn');
              // s usually like "۱۴۰۴/۸/۱۹" in persian digits; convert persian digits to latin:
              const digitsMap = {'۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
              let latin = '';
              for (let ch of s) latin += (digitsMap[ch] ?? ch);
              const m = latin.match(/^(\d{4})[\/\-]/);
              if (m) return parseInt(m[1],10);
            } catch(e){}
            // fallback: approximate (2025 -> 1404)
            const g = new Date();
            const fallback = g.getFullYear() - 621; // rough but OK for year listing
            return fallback;
          }

          function createPickerForInput(input, hiddenYear, hiddenMonth, hiddenDay, opts = {}) {
            if (!input) return null;
            let picker = null;

            function build() {
              if (picker) picker.remove();
              picker = document.createElement('div');
              picker.className = 'sh-datepicker hidden';
              // year range
              const currentShYear = getCurrentShamsiYear();
              const yearFrom = opts.yearFrom ?? DEFAULT_YEAR_FROM;
              const yearTo = opts.yearTo ?? (currentShYear + DEFAULT_YEAR_TO_OFFSET);

              // elements
              const row = document.createElement('div'); row.className = 'row';
              const selY = document.createElement('select');
              const selM = document.createElement('select');
              const selD = document.createElement('select');

              // populate years
              for (let y = yearTo; y >= yearFrom; y--) {
                const o = document.createElement('option'); o.value = y; o.text = y;
                selY.appendChild(o);
              }
              // months 1..12
              for (let m = 1; m <= 12; m++) {
                const o = document.createElement('option'); o.value = m; o.text = (m + ' - ' + ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'][m-1]);
                selM.appendChild(o);
              }
              // days 1..31
              for (let d = 1; d <= 31; d++) {
                const o = document.createElement('option'); o.value = d; o.text = pad(d);
                selD.appendChild(o);
              }

              // prefill from input if possible
              const cur = parseShamsiString(input.value);
              if (cur) {
                if (Array.from(selY.options).some(x=>x.value==cur.year)) selY.value = cur.year;
                selM.value = cur.month;
                selD.value = cur.day;
              } else {
                // use hidden values if present
                const hy = hiddenYear && hiddenYear.value ? hiddenYear.value : null;
                if (hy && Array.from(selY.options).some(x=>x.value==hy)) selY.value = hy;
                if (hiddenMonth && hiddenMonth.value) selM.value = hiddenMonth.value;
                if (hiddenDay && hiddenDay.value) selD.value = hiddenDay.value;
              }

              const rowwrap = document.createElement('div'); rowwrap.className = 'row';
              rowwrap.appendChild(selY);
              rowwrap.appendChild(selM);
              rowwrap.appendChild(selD);

              const actions = document.createElement('div'); actions.className = 'actions';
              const ok = document.createElement('button'); ok.type='button'; ok.className='btn-ok'; ok.textContent='انتخاب';
              const cancel = document.createElement('button'); cancel.type='button'; cancel.className='btn-cancel'; cancel.textContent='انصراف';

              actions.appendChild(cancel);
              actions.appendChild(ok);

              picker.appendChild(rowwrap);
              picker.appendChild(actions);

              // add to body
              document.body.appendChild(picker);

              // position
              const rect = input.getBoundingClientRect();
              const top = rect.bottom + window.scrollY + 8;
              // align to left of input for RTL languages it's okay
              const left = rect.left + window.scrollX;
              picker.style.top = `${top}px`;
              picker.style.left = `${left}px`;
              picker.classList.remove('hidden');

              // event handlers
              function closePicker() { if (picker) { picker.remove(); picker = null; document.removeEventListener('click', onDocClick); } }
              function onDocClick(e) {
                if (!picker) return;
                if (e.target === input) return;
                if (picker.contains(e.target)) return;
                closePicker();
              }
              // cancel
              cancel.addEventListener('click', function(){ closePicker(); input.focus(); });
              // ok -> write result to input and hidden fields
              ok.addEventListener('click', function(){
                const y = parseInt(selY.value,10);
                const m = parseInt(selM.value,10);
                const d = parseInt(selD.value,10);
                input.value = `${y}/${pad(m)}/${pad(d)}`;
                if (hiddenYear) hiddenYear.value = y;
                if (hiddenMonth) hiddenMonth.value = m;
                if (hiddenDay) hiddenDay.value = d;
                // trigger input event
                input.dispatchEvent(new Event('input', { bubbles: true }));
                closePicker();
                input.focus();
              });

              // click outside closes
              setTimeout(()=>document.addEventListener('click', onDocClick), 50);
            }

            function showPicker() {
              if (!picker) build(); else picker.classList.remove('hidden');
            }

            input.addEventListener('focus', showPicker);
            input.addEventListener('click', function(e){ e.stopPropagation(); showPicker(); });
            // if user manually types and leaves, sync hidden fields
            input.addEventListener('blur', function () {
              setTimeout(()=>{ // slight timeout so that OK click can run first
                const cur = parseShamsiString(input.value);
                if (cur) {
                  if (hiddenYear) hiddenYear.value = cur.year;
                  if (hiddenMonth) hiddenMonth.value = cur.month;
                  if (hiddenDay) hiddenDay.value = cur.day;
                }
              }, 120);
            });

            return {
              destroy: function () {
                if (picker) picker.remove();
              }
            };
          }

          // attach datepickers to both birth and entry inputs if present
          document.addEventListener('DOMContentLoaded', function(){
            // birth
            const birthInput = document.querySelector('input[name="BirthDateShamsi"], input[id="BirthDateShamsi"], input[asp-for="BirthDateShamsi"]');
            const entryInput = document.querySelector('input[name="EntryDateShamsi"], input[id="EntryDateShamsi"], input[asp-for="EntryDateShamsi"]');

            const hBirthY = document.getElementById('BirthYear');
            const hBirthM = document.getElementById('BirthMonth');
            const hBirthD = document.getElementById('BirthDay');

            const hEntryY = document.getElementById('EntryYear');
            const hEntryM = document.getElementById('EntryMonth');
            const hEntryD = document.getElementById('EntryDay');

            if (birthInput) {
              createPickerForInput(birthInput, hBirthY, hBirthM, hBirthD, { yearFrom: 1370, yearTo: 1410 });
            }
            if (entryInput) {
              createPickerForInput(entryInput, hEntryY, hEntryM, hEntryD, { yearFrom: 1370, yearTo: 1410 });
            }
          });
        })();
    </script>
    <script>
        (function () {
          // ----- Utility: نمایش پیام با Swal (یک‌جا و با استایل مشابه بقیه) -----
          function showSwalMessage(type, message, title) {
            const icon = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            const defaultTitle = type === 'error' ? 'خطا' : (type === 'success' ? 'موفق' : 'اطلاع');
            Swal.fire({
              icon: icon,
              title: title || defaultTitle,
              text: message || '',
              confirmButtonText: 'تأیید',
              buttonsStyling: false,
              customClass: {
                confirmButton:
                  type === 'success'
                    ? "inline-block w-full justify-between gap-4 px-3 py-2 bg-green-600 text-sm text-slate-100 rounded hover:bg-green-700 transition mt-3"
                    : type === 'error'
                      ? "inline-block w-full justify-between gap-4 px-3 py-2 bg-rose-600 text-sm text-slate-100 rounded hover:bg-rose-700 transition mt-3"
                      : "inline-block w-full justify-between gap-4 px-3 py-2 bg-pink-600 text-sm text-slate-100 rounded hover:bg-pink-700 transition mt-3"
              }
            });
          }

          // ----- Override native alert() so any existing alert(...) calls become styled Swal -----
          // (این تغییر امن است و فقط ظاهرسازی را جایگزین می‌کند)
          if (typeof window !== 'undefined') {
            window._nativeAlert = window.alert.bind(window);
            window.alert = function (msg) {
              try {
                showSwalMessage('error', String(msg));
              } catch (e) {
                // fallback to native if Swal missing or خطا داشت
                window._nativeAlert(msg);
              }
            };
          }

          // ----- Helper: parse and validate Shamsi string YYYY/MM/DD or YYYY-MM-DD -----
          function parseShamsiString(sh) {
            if (!sh) return null;
            sh = String(sh).trim().replace(/[\uFF0F\u2215]/g, '/');
            const m = sh.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
            if (!m) return null;
            const y = parseInt(m[1], 10), mo = parseInt(m[2], 10), d = parseInt(m[3], 10);
            if (mo < 1 || mo > 12) return null;
            if (d < 1 || d > 31) return null;
            return { year: y, month: mo, day: d };
          }

          // ----- Client-side validation for Create form (BirthDateShamsi & EntryDateShamsi) -----
          document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('form[asp-action="Create"], form[action*="/Students/Create"]') || document.querySelector('form');
            if (!form) return;

            form.addEventListener('submit', function (e) {
              // find inputs by name or asp-for
              const birthInput = form.querySelector('input[name="BirthDateShamsi"], input[id="BirthDateShamsi"], input[asp-for="BirthDateShamsi"]');
              const entryInput = form.querySelector('input[name="EntryDateShamsi"], input[id="EntryDateShamsi"], input[asp-for="EntryDateShamsi"]');

              // Validate function: if value present, must match YYYY/MM/DD and reasonable year range
              function validateShamsiField(inp, friendlyName, minYear = 1370, maxYear = 1410) {
                if (!inp) return { ok: true };
                const v = (inp.value || '').trim();
                if (!v) return { ok: true }; // allow empty unless server requires
                const parsed = parseShamsiString(v);
                if (!parsed) return { ok: false, message: `${friendlyName} نامعتبر است — از قالب YYYY/MM/DD استفاده کنید (مثلاً 1404/02/01).` };
                if (parsed.year < minYear || parsed.year > maxYear) {
                  return { ok: false, message: `${friendlyName} خارج از بازه مجاز است. بازهٔ مجاز: ${minYear} تا ${maxYear}.` };
                }
                return { ok: true, parsed };
              }

              // Validate birth date (user asked range 1370..1410 for pickers; use same here)
              const birthCheck = validateShamsiField(birthInput, 'تاریخ تولد', 1370, 1410);
              if (!birthCheck.ok) {
                e.preventDefault();
                e.stopImmediatePropagation();
                showSwalMessage('error', birthCheck.message, 'فرمت تاریخ نامعتبر');
                return false;
              }

              // Validate entry date (use same range; you can tweak if needed)
              const entryCheck = validateShamsiField(entryInput, 'تاریخ ورود به طرح', 1370, 1410);
              if (!entryCheck.ok) {
                e.preventDefault();
                e.stopImmediatePropagation();
                showSwalMessage('error', entryCheck.message, 'فرمت تاریخ نامعتبر');
                return false;
              }

              // اگر به hidden year/month/day هم نیاز داری (مثلاً برای ارسال جداگانه)،
              // اینجا می‌توانیم hiddenها را پر کنیم — اما چون مدل تو از EntryYear/EntryMonth/EntryDay استفاده می‌کند،
              // بهتر است hiddenهایی با id های EntryYear/EntryMonth/EntryDay و BirthYear/BirthMonth/BirthDay در فرم داشته باشی.
              // اگر وجود داشته باشند، مقدارها را ست می‌کنیم:
              try {
                if (birthInput && birthCheck.parsed) {
                  const hy = document.getElementById('BirthYear');
                  const hm = document.getElementById('BirthMonth');
                  const hd = document.getElementById('BirthDay');
                  if (hy) hy.value = birthCheck.parsed.year;
                  if (hm) hm.value = birthCheck.parsed.month;
                  if (hd) hd.value = birthCheck.parsed.day;
                }
                if (entryInput && entryCheck.parsed) {
                  const ey = document.getElementById('EntryYear');
                  const em = document.getElementById('EntryMonth');
                  const ed = document.getElementById('EntryDay');
                  if (ey) ey.value = entryCheck.parsed.year;
                  if (em) em.value = entryCheck.parsed.month;
                  if (ed) ed.value = entryCheck.parsed.day;
                }
              } catch (ex) {
                // ignore — فقط کمک به سازگاری hidden fields
              }

              // اجازهٔ ارسال فرم ادامه یابد
              return true;
            }, { passive: false });
          });

          // ----- Optional: convert existing plain alerts from other scripts by wrapping showLocalNotify -----
          // اگر در صفحات دیگر از showLocalNotify استفاده شده و تمایل داری همه پیام‌ها با Swal نمایش یابند، می‌توانی map کنی:
          window.showLocalNotify = function (msg, type) {
            if (type === 'error') showSwalMessage('error', msg);
            else if (type === 'success') showSwalMessage('success', msg);
            else showSwalMessage('info', msg);
          };

        })();
    </script>
}